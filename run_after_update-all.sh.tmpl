#!/usr/bin/env zsh

if command -v toilet >/dev/null 2>&1; then
  toilet -F border UPDATING
fi

if command -v nix >/dev/null 2>&1; then
  # possibly not avaialable on first run
  if command -v banner >/dev/null 2>&1; then
    toilet NIX
  else
    echo "############ NIX ############"  
  fi
  # update nix packages
  nix-channel --update
  # cleanup old generations
  # turning it on seem to break home-manager on some nix installs
  # deactivete it if needed
  {{- if .nixCleanup }}
  nix-collect-garbage --delete-older-than 30d
  {{- end }}

fi

# build new derivation
if command -v home-manager >/dev/null 2>&1; then
  toilet HOME
  home-manager switch
fi  

# sometimes completions need to be cleaned up
find -L $HOME/.local/share/zinit/completions -type l -exec rm -- {} +

# update zinit plugins
# not need to update zinit as it is updated by home-manager
toilet ZINIT
# init zinit for updates
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
source "${ZINIT_HOME}/zinit.zsh"
# update everything
zinit update --all --parallel 20 -v
echo "\n"

toilet -F border DONE

source $HOME/.zshrc

