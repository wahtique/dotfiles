#!/usr/bin/env zsh

if command -v toilet >/dev/null 2>&1; then
  toilet -F border UPDATING
fi

if command -v nix >/dev/null 2>&1; then
  # possibly not avaialable on first run
  if command -v banner >/dev/null 2>&1; then
    toilet NIX
  else
    echo "############ NIX ############"  
  fi
  # update nix packages
  nix-channel --update
  # cleanup old generations
  # turning it on seem to break home-manager on some nix installs
  # deactivete it if needed
  {{- if .nixCleanup }}
  nix-collect-garbage --delete-older-than 30d
  {{- end }}

fi

# build new derivation
if command -v home-manager >/dev/null 2>&1; then
  toilet HOME
  home-manager switch
fi  

# sometimes completions need to be cleaned up
find -L $HOME/.local/share/zinit/completions -type l -exec rm -- {} +

# init shell
source ~/.zshrc

# update zinit plugins
# not need to update zinit as it is updated by home-manager
if command -v zinit >/dev/null 2>&1; then
  toilet ZINIT
  zinit update --parallel 100
  source ~/.zshrc
  echo "\n"
fi

toilet -F border DONE

